---
import { Image } from "astro:assets";
import type { ImageMetadata } from "astro";
import img1 from "../assets/img/about/1.png";
import img2 from "../assets/img/about/2.png";
import img3 from "../assets/img/about/3.png";
import img4 from "../assets/img/about/4.png";

const photos: Array<{ img: ImageMetadata; alt: string; cls: string }> = [
  {
    img: img1,
    alt: "Mirror selfie of Wint Khant Lin",
    cls: "card-a",
  },
  {
    img: img2,
    alt: "Photography taken by Wint Khant Lin",
    cls: "card-b",
  },
  {
    img: img3,
    alt: "Wint Khant Lin in Shan State",
    cls: "card-c",
  },
  {
    img: img4,
    alt: "Wint Khant Lin pitching at hackathon rehearsal",
    cls: "card-d",
  },
];
---

<div class="collage-shell w-full py-4">
  <div id="photo-collage" class="photo-collage relative mx-auto w-[min(88vw,460px)] h-107.5 sm:h-125">
    {
      photos.map((photo) => (
        <figure
          class={`photo-card absolute ${photo.cls}`}
          tabindex="0"
          role="button"
          aria-label={`Focus ${photo.alt}`}
        >
          <div class="photo-inner">
            <Image
              src={photo.img}
              alt={photo.alt}
              class="h-full w-full rounded-[0.8rem] object-cover"
              loading="lazy"
            />
          </div>
          <figcaption class="sr-only">{photo.alt}</figcaption>
        </figure>
      ))
    }
  </div>
</div>

<style>
  .photo-collage {
    perspective: 900px;
  }

  .photo-card {
    border: 2px solid rgba(24, 24, 24, 0.92);
    border-radius: 16px 10px 20px 11px / 13px 18px 11px 20px;
    background: white;
    padding: 8px;
    box-shadow: 6px 7px 0 rgba(24, 24, 24, 0.95);
    will-change: transform;
    cursor: pointer;
    transition: box-shadow 180ms ease;
  }

  .photo-card::before {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    pointer-events: none;
    background: radial-gradient(circle at 20% 14%, rgba(255, 255, 255, 0.8), transparent 44%);
    opacity: 0.4;
  }

  .photo-inner {
    height: 100%;
    overflow: hidden;
    border-radius: 0.9rem;
  }

  .card-a {
    left: 2%;
    top: 2%;
    width: 58%;
    height: 55%;
    transform: rotate(-7deg);
    z-index: 4;
  }

  .card-b {
    right: 0;
    top: 7%;
    width: 44%;
    height: 38%;
    transform: rotate(8deg);
    z-index: 3;
  }

  .card-c {
    right: 2%;
    bottom: 6%;
    width: 56%;
    height: 52%;
    transform: rotate(5deg);
    z-index: 2;
  }

  .card-d {
    left: 8%;
    bottom: 0;
    width: 42%;
    height: 34%;
    transform: rotate(-10deg);
    z-index: 5;
  }

  .photo-card.is-front {
    box-shadow: 10px 11px 0 rgba(24, 24, 24, 0.95);
  }

  .photo-card:focus-visible {
    outline: 3px solid var(--highlighter-blue);
    outline-offset: 3px;
  }

  @media (max-width: 640px) {
    .photo-card {
      padding: 6px;
      box-shadow: 4px 5px 0 rgba(24, 24, 24, 0.95);
    }
  }
</style>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  let collageContext: gsap.Context | undefined;
  let collageAbortController: AbortController | undefined;

  const cleanupCollage = () => {
    collageContext?.revert();
    collageContext = undefined;
    collageAbortController?.abort();
    collageAbortController = undefined;
  };

  const initCollage = () => {
    const root = document.getElementById("photo-collage");
    if (!root) return;

    cleanupCollage();
    collageAbortController = new AbortController();

    collageContext = gsap.context(() => {
      const cards = gsap.utils.toArray<HTMLElement>("#photo-collage .photo-card");
      const stack = [...cards].sort(
        (a, b) =>
          Number.parseInt(getComputedStyle(b).zIndex, 10) -
          Number.parseInt(getComputedStyle(a).zIndex, 10)
      );

      const applyStack = (animate = false) => {
        stack.forEach((card, index) => {
          const z = cards.length - index;
          card.classList.toggle("is-front", index === 0);
          if (animate) {
            gsap.to(card, {
              zIndex: z,
              duration: 0.22,
              ease: "power2.out",
            });
          } else {
            gsap.set(card, { zIndex: z });
          }
        });
      };

      const focusCard = (card: HTMLElement) => {
        const currentIndex = stack.indexOf(card);
        if (currentIndex === -1) return;

        if (currentIndex === 0) {
          const first = stack.shift()!;
          stack.push(first);
        } else {
          stack.splice(currentIndex, 1);
          stack.unshift(card);
        }

        applyStack(true);
        gsap.fromTo(
          stack[0],
          { scale: 1.03 },
          { scale: 1, duration: 0.24, ease: "power2.out" }
        );
      };

      applyStack(false);

      gsap.from(cards, {
        opacity: 0,
        y: 55,
        scale: 0.92,
        duration: 0.85,
        ease: "power3.out",
        stagger: 0.1,
        scrollTrigger: {
          trigger: root,
          start: "top 82%",
          once: true,
        },
      });

      cards.forEach((card, index) => {
        gsap.to(card, {
          y: index % 2 === 0 ? -8 : 8,
          x: index % 2 === 0 ? 4 : -4,
          duration: 2.6 + index * 0.22,
          ease: "sine.inOut",
          repeat: -1,
          yoyo: true,
        });

        card.addEventListener(
          "click",
          () => {
            focusCard(card);
          },
          { signal: collageAbortController?.signal }
        );

        card.addEventListener(
          "keydown",
          (event) => {
            if (event.key !== "Enter" && event.key !== " ") return;
            event.preventDefault();
            focusCard(card);
          },
          { signal: collageAbortController?.signal }
        );
      });
    }, root);
  };

  document.addEventListener("astro:before-swap", cleanupCollage);
  document.addEventListener("astro:page-load", initCollage);

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initCollage, { once: true });
  } else {
    initCollage();
  }
</script>
