---
const links = [
  { label: "Home", href: "/#home", id: "home" },
  { label: "Work", href: "/#projects", id: "projects" },
  { label: "About", href: "/#about", id: "about" },
];
---

<header class="fixed top-0 left-0 right-0 z-130 pointer-events-none px-4 sm:px-6 lg:px-8">
  <div class="mx-auto mt-3.5 w-full max-w-6xl">
    <div
      data-header-shell
      class="header-shell pointer-events-auto relative overflow-hidden px-3 py-2 sm:px-4"
    >
      <div class="header-grain pointer-events-none absolute inset-0" />

      <div class="relative z-10 grid grid-cols-[auto_1fr_auto] items-center gap-3">
        <a
          href="/"
          class="heading-sans brand-stamp inline-flex items-center rounded-full border border-black/55 bg-white/92 px-4 py-2 text-sm font-black uppercase tracking-[0.12em] ink-text"
        >
          WKL
        </a>

        <nav
          data-desktop-nav
          class="relative hidden min-w-0 items-center justify-center rounded-full border border-black/22 bg-white/78 p-1.5 md:flex"
        >
          <div
            id="nav-spotlight"
            class="absolute left-0 top-1.5 h-[calc(100%-12px)] w-0 rounded-full bg-(--highlighter-blue)/25 opacity-0 transition-all duration-250 ease-out"
          >
          </div>
          {
            links.map((link) => (
              <a
                href={link.href}
                class="nav-link body-mono relative z-10 block rounded-full px-4 py-1.5 text-[0.84rem] font-semibold uppercase tracking-[0.06em] ink-text outline-none transition-colors duration-200 hover:text-black focus-visible:ring-2 focus-visible:ring-(--highlighter-blue)"
                data-section={link.id}
              >
                {link.label}
              </a>
            ))
          }
        </nav>

        <div class="flex items-center justify-end gap-2">
          <button
            type="button"
            data-menu-toggle
            class="menu-toggle body-mono inline-flex h-9 w-9 items-center justify-center rounded-full border border-black/45 bg-white text-xs font-bold uppercase text-black outline-none transition hover:bg-(--highlighter-yellow)/26 focus-visible:ring-2 focus-visible:ring-(--highlighter-blue) md:hidden"
            aria-expanded="false"
            aria-controls="mobile-menu"
            aria-label="Toggle navigation menu"
          >
            <span data-menu-label>Menu</span>
          </button>
        </div>
      </div>

      <div
        id="mobile-menu"
        data-mobile-panel
        class="relative z-10 max-h-0 overflow-hidden transition-[max-height] duration-250 ease-out md:hidden"
      >
        <nav class="mt-3 grid gap-2 rounded-2xl border border-black/20 bg-white/80 p-2">
          {
            links.map((link) => (
              <a
                href={link.href}
                class="mobile-nav-link body-mono rounded-xl border border-black/8 px-3 py-2 text-[0.82rem] font-semibold uppercase tracking-[0.06em] ink-text transition hover:bg-(--highlighter-blue)/24"
                data-section={link.id}
              >
                {link.label}
              </a>
            ))
          }
        </nav>
      </div>
    </div>
  </div>
</header>

<style>
  .header-shell {
    border: 1.5px solid rgba(24, 24, 24, 0.5);
    border-radius: 14px;
    background: color-mix(in srgb, var(--paper-cream) 92%, white 8%);
    box-shadow: 2px 3px 0 rgba(24, 24, 24, 0.3);
    backdrop-filter: blur(10px);
  }

  .header-grain {
    opacity: 0.04;
    background-image: radial-gradient(circle at center, rgba(24, 24, 24, 0.2) 0.6px, transparent 0.7px);
    background-size: 5px 5px;
  }

  .brand-stamp {
    box-shadow: 1px 2px 0 rgba(24, 24, 24, 0.28);
  }

  .nav-link.is-active,
  .mobile-nav-link.is-active {
    color: black;
    background-color: color-mix(in srgb, var(--highlighter-blue) 22%, white 78%);
    border: 1px solid rgba(24, 24, 24, 0.24);
  }

  .menu-toggle {
    box-shadow: 1px 2px 0 rgba(24, 24, 24, 0.24);
  }
</style>

<script>
  let headerAbortController: AbortController | undefined;
  let sectionObserver: IntersectionObserver | undefined;

  const initHeader = () => {
    headerAbortController?.abort();
    headerAbortController = new AbortController();
    sectionObserver?.disconnect();
    sectionObserver = undefined;

    const shell = document.querySelector<HTMLElement>("[data-header-shell]");
    if (!shell) return;

    const desktopNav = shell.querySelector<HTMLElement>("[data-desktop-nav]");
    const spotlight = shell.querySelector<HTMLElement>("#nav-spotlight");
    const desktopLinks = shell.querySelectorAll<HTMLAnchorElement>(".nav-link");
    const mobileLinks = shell.querySelectorAll<HTMLAnchorElement>(".mobile-nav-link");
    const toggleBtn = shell.querySelector<HTMLButtonElement>("[data-menu-toggle]");
    const toggleLabel = shell.querySelector<HTMLElement>("[data-menu-label]");
    const mobilePanel = shell.querySelector<HTMLElement>("[data-mobile-panel]");

    const allLinks = [...desktopLinks, ...mobileLinks];
    const sections = ["home", "projects", "about"];
    let activeSection = "home";
    let menuOpen = false;

    const setActive = (sectionId: string) => {
      activeSection = sectionId;
      allLinks.forEach((link) => {
        const isMatch = link.dataset.section === sectionId;
        link.classList.toggle("is-active", isMatch);
        link.setAttribute("aria-current", isMatch ? "page" : "false");
      });

      const activeDesktopLink = shell.querySelector<HTMLAnchorElement>(
        `.nav-link[data-section="${sectionId}"]`
      );
      if (desktopNav && spotlight && activeDesktopLink) {
        const navRect = desktopNav.getBoundingClientRect();
        const linkRect = activeDesktopLink.getBoundingClientRect();
        spotlight.style.width = `${linkRect.width}px`;
        spotlight.style.transform = `translateX(${linkRect.left - navRect.left}px)`;
        spotlight.style.opacity = "1";
      }
    };

    const closeMenu = () => {
      if (!toggleBtn || !mobilePanel || !toggleLabel) return;
      menuOpen = false;
      toggleBtn.setAttribute("aria-expanded", "false");
      toggleLabel.textContent = "Menu";
      mobilePanel.style.maxHeight = "0px";
    };

    if (toggleBtn && mobilePanel && toggleLabel) {
      toggleBtn.addEventListener(
        "click",
        () => {
          menuOpen = !menuOpen;
          toggleBtn.setAttribute("aria-expanded", menuOpen ? "true" : "false");
          toggleLabel.textContent = menuOpen ? "Close" : "Menu";
          mobilePanel.style.maxHeight = menuOpen ? `${mobilePanel.scrollHeight + 10}px` : "0px";
        },
        { signal: headerAbortController?.signal }
      );
    }

    mobileLinks.forEach((link) => {
      link.addEventListener(
        "click",
        () => {
          closeMenu();
        },
        { signal: headerAbortController?.signal }
      );
    });

    if (desktopNav && spotlight) {
      desktopLinks.forEach((link) => {
        link.addEventListener(
          "mouseenter",
          () => {
            const navRect = desktopNav.getBoundingClientRect();
            const linkRect = link.getBoundingClientRect();
            spotlight.style.width = `${linkRect.width}px`;
            spotlight.style.transform = `translateX(${linkRect.left - navRect.left}px)`;
            spotlight.style.opacity = "1";
          },
          { signal: headerAbortController?.signal }
        );

        link.addEventListener(
          "focus",
          () => {
            const navRect = desktopNav.getBoundingClientRect();
            const linkRect = link.getBoundingClientRect();
            spotlight.style.width = `${linkRect.width}px`;
            spotlight.style.transform = `translateX(${linkRect.left - navRect.left}px)`;
            spotlight.style.opacity = "1";
          },
          { signal: headerAbortController?.signal }
        );
      });

      desktopNav.addEventListener(
        "mouseleave",
        () => {
          setActive(activeSection);
        },
        { signal: headerAbortController?.signal }
      );
    }

    sectionObserver = new IntersectionObserver(
      (entries) => {
        const visible = entries
          .filter((entry) => entry.isIntersecting)
          .sort((a, b) => b.intersectionRatio - a.intersectionRatio);
        if (!visible.length) return;
        setActive(visible[0].target.id);
      },
      {
        rootMargin: "-35% 0px -45% 0px",
        threshold: [0.2, 0.4, 0.65],
      }
    );

    sections.forEach((id) => {
      const section = document.getElementById(id);
      if (section) sectionObserver?.observe(section);
    });

    setActive("home");
  };

  const cleanupHeader = () => {
    headerAbortController?.abort();
    headerAbortController = undefined;
    sectionObserver?.disconnect();
    sectionObserver = undefined;
  };

  document.addEventListener("astro:before-swap", cleanupHeader);
  document.addEventListener("astro:page-load", initHeader);

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initHeader, { once: true });
  } else {
    initHeader();
  }
</script>
